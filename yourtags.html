<!DOCTYPE html>
<html lang="en">
<head>
	<script src="js/fs-wrapper.js"></script>
	<link href="bootstrap/css/bootstrap.css" rel="stylesheet" />
	<link href="bootstrap/css/bootstrap-responsive.css" rel="stylesheet" />
	<link href="styles.css" rel="stylesheet" />
	<!-- <link href="bootstrap/css/style.css?a1" rel="stylesheet" /> -->
	<link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <script src="js/tag-filter.js"></script>
    
    <script src="js/yelp-wrapper.js"></script>
    <script src="js/mustache.js"></script>
    <script src="js/jquery_1.8.2.min.js"></script>
		<script type="text/javascript">

			function addTag(e) {
				// Adds the tag e to div#chosen-tags and removes it from the div#existing-tags.
				var $e = $(e);

				$e.attr('onclick', 'removeTag(this)');

				$e.remove();
				$e.appendTo($('#chosen-tags'));
				$remove = $e.find($('.tag-remove'));
				$remove.css('display', 'inline');

				$e.removeClass('clear-both');
				//	$("#tag-list").val($('#tag-list').val() + '"' + $e.attr("id") + '"'); 
			}

			function removeTag(e) {
				// Removes the tag e from div#chosen-tags and adds it back to div#existing-tags. 
				var $e = $(e);

				$e.attr('onclick', 'addTag(this)');
				$e.addClass('tag-clickable clear-both');

				$e.appendTo($('#existing-tags'));
				$remove = $e.find($('.tag-remove'));
				$remove.css('display', 'none');
			}

			function loadExistingTags(tags) {
				// Pulls user's existing tags from file and displays them in the div#existing-tags as clickable tags. 
				tags.sort();
			   	for(var i = 0; i < tags.length; i++) {
			   		var tag = tags[i];
			   		$('#existing-tags').append('<span id ="' + tag + '" class="tag tag-clickable clear-both pull-left" onclick="addTag(this);">' + tag + '<button class="close tag-remove" style="display:none; color: white;">&times;</button></span>');
			   	}
			}

			function getChosenTags() {
				// Puts all selected tags into the #tag-list search form. File System API will use this list of tags to retrieve businesses. 

				$("#tag-list").val("");
				$("#chosen-tags span").each(function(index) {
					$("#tag-list").val($('#tag-list').val() + ' "' + $(this).attr("id") + '"');
				})
			}

			function displayResults(file) {
					getChosenTags();
				$.get(file, 
					function(data){
					$("#results").empty();	
					var $numResults = data.businesses.length;
				   	for (i = 0; i < $numResults; i++) {
					   	var $id = data.businesses[i].id;
					   	var $name = data.businesses[i].name;
					   	var $categories = data.businesses[i].categories;
					   	var $display_phone = data.businesses[i].display_phone;
					   	var $image_url = data.businesses[i].image_url;
					   	var $address = data.businesses[i].location.address;
					   	var $city = data.businesses[i].location.city;
					   	var $state_code = data.businesses[i].location.state_code;
					   	var $neighborhoods = data.businesses[i].location.neighborhoods;
					   	if(typeof($neighborhoods) == 'undefined') $neighborhoods = '';
					   	var $rating_img_url = data.businesses[i].rating_img_url;
					   	var $review_count = data.businesses[i].review_count;
					   	var $url = data.businesses[i].url;
					   	var $tags = data.businesses[i].tags;

					    $('#results').append('<a href="' + $url + '"> <div id ="' + $id + '"class="well well-small clearfix result"><div class="span2"><img class="thumbnail" src="' + $image_url + '"></div> <div class="span3 pull-left"><h4 class="yelp-red">' + $name + '</h4> <p><b> Neighborhoods: </b>' + $neighborhoods + '</p><p class="categories"><b> Categories: </b></div><div class="middle span3 pull-left"> <img src="' + $rating_img_url + '"> ' + $review_count + ' reviews <address>' + $display_phone + '<br>' + $address + '<br>' + $city + ', ' + $state_code + '</address></div><div class="span4 pull-left biz-tags"><button class="pull-right btn btn-large btn-success"> Edit Tags! </button><h4> Your Tags </h4></div></div></a>');

					     processTags($tags, $id);
					     processCategories($categories, $id);
				    }
				   }, "json");
					
				function processTags(e, id) {
				var $e = $(e);
				jQuery.each($e, function(i, val){
						$("#" + id + " div.biz-tags").append('<span id="' + val + '" class="tag pull-left">' + val + ' </span>');
				});
				}

				function processCategories(e, id) {
				var $e = $(e);
				jQuery.each($e, function(i, val){
						$("#" + id + " p.categories").append(val[0] + ", ");
				});
				}
			}

			$(document).ready( function () { 
				var delayed = function() {
					getTags(function (tags){
						loadExistingTags(tags);
					});	
				}

				setTimeout(delayed, 500);
				
			});
		</script>
</head>
<body>
	<div id="body-wrapper">
		<div class="container">
			<!-- Navbar and Search Bar -->
	        <div>
	          <ul class="nav nav-tabs">
	        	  <li>
	        	    <a href="search-results.html">Home</a>
	        	  </li>
	        	  <li class="active">
	              <a href="yourtags.html">Your Tags</a>
	            </li>
	          </ul>
	        </div>
			<div class="row-fluid">
				<div id ="existing-tags-container" class="span2 well well-small">
					<!-- Sidebar for tags -->
					<h2> Tag List </h2>
					<p> Click on tag to filter by that tag </p>
						<div id ="existing-tags" >
						</div>
				</div>
				<div class="span10">
					<!-- Main content for filtered businesses go here -->
					<button type="submit" class="btn btn-info pull-left" onclick="displayResults('real-data.txt')"> Filter </button>
		  			<div id="chosen-tags" class="span10 well well-small pull-left clear-right">
					</div>
					<input type="text" id="tag-list" class="input-large span12 search-query" placeholder="tags">
					<div>
						<h3> Filtered Results </h3>
						<hr style="margin-top: 5px;">
						<div id="results">
								<!-- Filtered Results Start Here -->
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
<body>
</html>